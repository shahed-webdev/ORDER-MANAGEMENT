
@{
    ViewBag.Title = "Order Report";
    Layout = "~/Views/Shared/_AdminLayoutPage.cshtml";
}

@section Styles {
    <link href="~/CSS/bootstrap-select.css" rel="stylesheet" />
    <style>
        .selected .dropdown-item { color: #2b9000 }
    </style>
}

<h3 class="mb-3">Order Report</h3>

<div class="card card-body">
    <form id="formFind">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label>From Date</label>
                    <input id="inputFromDate" type="date" class="form-control" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>To Date</label>
                    <input id="inputToDate" type="date" class="form-control" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Region</label>
                    @Html.DropDownList("Region", (IEnumerable<SelectListItem>)ViewBag.Region, "[ REGION ]", new { @class = "form-control", id = "dlRegion" })
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Area</label>
                    <select id="dlArea" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Territory</label>
                    <select id="dlTerritory" class="form-control selectpicker" multiple></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Depot</label>
                    <select id="dlDepot" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Distributor</label>
                    <select id="dlDistributor" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Outlet</label>
                    <select id="dlOutlet" class="form-control"></select>
                </div>
            </div>
        </div>

        <input type="submit" value="Find" class="btn btn-primary" />
    </form>

    <table class="table table-sm mt-3">
        <thead>
            <tr>
                <th><strong>Product Code</strong></th>
                <th><strong>Product Name</strong></th>
                <th><strong>Order Quantity</strong></th>
            </tr>
        </thead>
    </table>
</div>

@section Scripts {
    <script src="~/JS/bootstrap-select.js"></script>

    <script>
        $(function () {
            $(".selectpicker").selectpicker({
                actionsBox: true,
                liveSearch: false,
                selectedTextFormat: 'count > 4',
                style: '',
                styleBase: 'form-control',
                tickIcon: 'fas fa-check-circle',
                size: 5
            });
        })

        const selectRegion = document.getElementById("dlRegion");
        const selectArea = document.getElementById("dlArea");
        const selectTerritory = document.getElementById("dlTerritory");
        const selectDepot = document.getElementById("dlDepot");

        //select region
        selectRegion.addEventListener("change", function (evt) {
            const regionId = this.value;

            selectArea.options.length = 0;
            selectTerritory.options.length = 0;
            selectDepot.options.length = 0;

            if (!regionId) return;

            //get area
            $.ajax({
                url: "/Report/SelectAreaByRegion",
                data: { regionId },
                success: function (response) {
                    if (!response.length) return;

                    selectArea.appendChild(AddOption("0", "[ AREA ]"));
                    response.forEach(item => {
                        selectArea.appendChild(AddOption(item.AreaID, item.AreaName));
                    });
                },
                error: err => console.log(err)
            });

            //get depot
            $.ajax({
                url: "/Report/SelectDepotByRegion",
                data: { regionId },
                success: function (response) {
                    if (!response.length) return;

                    selectDepot.appendChild(AddOption("0", "[ DEPOT ]"));
                    response.forEach(item => {
                        selectDepot.appendChild(AddOption(item.value, item.label));
                    });
                },
                error: err => console.log(err)
            });
        });

        //select area
        selectArea.addEventListener("change", function (evt) {
            const areaId = this.value;

            selectTerritory.options.length = 0;
            $("#dlTerritory").selectpicker("refresh");

            if (!areaId) return;

            $.ajax({
                url: "/Report/SelectTerritoryByArea",
                data: { areaId },
                success: function (response) {
                    if (!response.length) return;

                    selectTerritory.appendChild(AddOption("0", "[ TERRITORY ]"));
                    response.forEach(item => {
                        selectTerritory.appendChild(AddOption(item.TerritoryID, item.TerritoryName));
                    });

                    $("#dlTerritory").selectpicker("refresh");
                },
                error: err => console.log(err)
            });
        });



        //add options in select
        function AddOption(value, text) {
            const option = document.createElement('option');
            option.value = value;
            option.innerHTML = text;

            return option;
        }


        //find submit
        const formFind = document.getElementById("formFind");
        formFind.addEventListener("submit", function (evt) {
            evt.preventDefault();

            const filter = {
                RegionID: +this.dlRegion.value,
                AreaID: +this.dlArea.value,
                TerritoryID: +this.dlTerritory.value,
                OutletID: +this.dlOutlet.value,
                DistributorID: +this.dlDistributor.value,
                DepotId: +this.dlDepot.value,
                SDateTime: this.inputFromDate.value,
                EDateTime: this.inputToDate.value
            }

            const ids = [];
            $('#dlTerritory :selected').each(function (i, selected) {
                ids[i] = parseInt($(selected).val());
            });

            $.ajax({
                url: "/Report/GetOrderReport",
                data: filter,
                success: function (response) {
                    console.log(response)
                },
                error: err => console.log(err)
            });
        });
    </script>
}